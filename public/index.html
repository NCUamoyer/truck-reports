<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vehicle Management Suite - Dashboard</title>
  <link rel="stylesheet" href="/css/variables.css">
  <link rel="stylesheet" href="/css/global.css">
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
  <header class="header">
    <div class="container">
      <div class="header-content">
        <div class="logo">
          <i data-lucide="truck" style="width: 28px; height: 28px;"></i>
          Vehicle Management Suite
        </div>
        <nav class="nav">
          <a href="/" class="active">Dashboard</a>
          <a href="/report-form">New Report</a>
          <a href="/reports-table">View Reports</a>
          <a href="/vehicle-management">Vehicles</a>
        </nav>
      </div>
    </div>
  </header>

  <main class="container" style="padding: 32px 24px;">
    <h1 style="margin-bottom: 32px;">Dashboard</h1>

    <!-- Statistics -->
    <div class="grid grid-cols-3" style="margin-bottom: 48px;">
      <div class="card">
        <div style="color: var(--gray-600); font-size: var(--text-sm); margin-bottom: 8px;">
          Total Reports
        </div>
        <div id="total-reports" style="font-size: var(--text-4xl); font-weight: 700; color: var(--primary-blue);">
          <div class="spinner"></div>
        </div>
      </div>

      <div class="card">
        <div style="color: var(--gray-600); font-size: var(--text-sm); margin-bottom: 8px;">
          Total Vehicles
        </div>
        <div id="total-vehicles" style="font-size: var(--text-4xl); font-weight: 700; color: var(--success);">
          <div class="spinner"></div>
        </div>
      </div>

      <div class="card">
        <div style="color: var(--gray-600); font-size: var(--text-sm); margin-bottom: 8px;">
          Last 30 Days
        </div>
        <div id="recent-reports" style="font-size: var(--text-4xl); font-weight: 700; color: var(--warning);">
          <div class="spinner"></div>
        </div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="card" style="margin-bottom: 48px;">
      <h2 style="margin-bottom: 24px;">Quick Actions</h2>
      <div class="grid grid-cols-3" style="gap: 16px;">
        <a href="/report-form" class="btn btn-primary btn-lg" style="display: flex; align-items: center; justify-content: center; gap: 8px;">
          <i data-lucide="file-plus" style="width: 20px; height: 20px;"></i>
          New Report
        </a>
        <a href="/reports-table" class="btn btn-secondary btn-lg" style="display: flex; align-items: center; justify-content: center; gap: 8px;">
          <i data-lucide="table" style="width: 20px; height: 20px;"></i>
          View Reports
        </a>
        <a href="/vehicle-management" class="btn btn-success btn-lg" style="display: flex; align-items: center; justify-content: center; gap: 8px;">
          <i data-lucide="truck" style="width: 20px; height: 20px;"></i>
          Manage Fleet
        </a>
      </div>
    </div>

    <!-- Fleet Overview -->
    <div class="card" style="margin-bottom: 48px;">
      <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
        <h2 class="card-title">Fleet Overview</h2>
        <a href="/vehicle-management" class="btn btn-sm btn-primary">
          <i data-lucide="truck" style="width: 16px; height: 16px;"></i>
          Manage Vehicles
        </a>
      </div>
      <div id="fleet-overview">
        <div style="text-align: center; padding: 40px;">
          <div class="spinner" style="width: 40px; height: 40px;"></div>
          <p style="margin-top: 16px; color: var(--gray-600);">Loading fleet data...</p>
        </div>
      </div>
    </div>

    <!-- Recent Reports -->
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">Recent Reports</h2>
      </div>
      <div id="recent-reports-list">
        <div style="text-align: center; padding: 40px;">
          <div class="spinner" style="width: 40px; height: 40px;"></div>
          <p style="margin-top: 16px; color: var(--gray-600);">Loading recent reports...</p>
        </div>
      </div>
      <div style="margin-top: 24px; text-align: center;">
        <a href="/reports-table" class="btn btn-secondary">View All Reports</a>
      </div>
    </div>
  </main>

  <script src="/js/api.js"></script>
  <script>
    // Load statistics
    async function loadDashboard() {
      try {
        // Load statistics
        const stats = await api.getStatistics();
        document.getElementById('total-reports').textContent = stats.totalReports;
        document.getElementById('total-vehicles').textContent = stats.totalVehicles;
        document.getElementById('recent-reports').textContent = stats.reportsLast30Days;

        // Load fleet overview
        renderFleetOverview(stats.vehiclesByStatus || {});

        // Load recent reports
        const result = await api.getReports({ limit: 5, sortBy: 'created_at', order: 'DESC' });
        renderRecentReports(result.reports);
      } catch (error) {
        console.error('Failed to load dashboard:', error);
        showError();
      }
    }

    function renderFleetOverview(vehiclesByStatus) {
      const container = document.getElementById('fleet-overview');
      
      const statusConfig = {
        active: { label: 'Active', color: 'var(--success)', bgColor: 'var(--success-light)', icon: 'check-circle' },
        maintenance: { label: 'Maintenance', color: 'var(--warning)', bgColor: 'var(--warning-light)', icon: 'wrench' },
        out_of_service: { label: 'Out of Service', color: 'var(--error)', bgColor: 'var(--error-light)', icon: 'alert-circle' },
        retired: { label: 'Retired', color: 'var(--gray-500)', bgColor: 'var(--gray-200)', icon: 'archive' }
      };

      const total = Object.values(vehiclesByStatus).reduce((sum, count) => sum + count, 0);

      if (total === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 40px; color: var(--gray-600);">
            <i data-lucide="truck" style="width: 64px; height: 64px; margin-bottom: 16px; stroke-width: 1.5;"></i>
            <p>No vehicles in the fleet yet</p>
          </div>
        `;
        lucide.createIcons();
        return;
      }

      container.innerHTML = `
        <div class="grid grid-cols-4" style="gap: 16px;">
          ${Object.entries(statusConfig).map(([status, config]) => {
            const count = vehiclesByStatus[status] || 0;
            const percentage = total > 0 ? Math.round((count / total) * 100) : 0;
            
            return `
              <div style="background: ${config.bgColor}; padding: 20px; border-radius: var(--radius-lg); border: 2px solid ${config.color}; transition: all var(--transition-fast); cursor: pointer;" onclick="window.location.href='/vehicle-management?status=${status}'">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                  <i data-lucide="${config.icon}" style="width: 28px; height: 28px; color: ${config.color};"></i>
                  <div style="font-size: var(--text-3xl); font-weight: 700; color: ${config.color};">
                    ${count}
                  </div>
                </div>
                <div style="color: ${config.color}; font-weight: 600; font-size: var(--text-sm); text-transform: uppercase; letter-spacing: 0.5px;">
                  ${config.label}
                </div>
                <div style="margin-top: 8px; color: ${config.color}; font-size: var(--text-xs); opacity: 0.8;">
                  ${percentage}% of fleet
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
      
      lucide.createIcons();
    }

    function renderRecentReports(reports) {
      const container = document.getElementById('recent-reports-list');
      
      if (reports.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 40px; color: var(--gray-600);">
            <i data-lucide="clipboard" style="width: 64px; height: 64px; margin-bottom: 16px; stroke-width: 1.5;"></i>
            <p>No reports yet. Create your first report!</p>
          </div>
        `;
        lucide.createIcons();
        return;
      }

      container.innerHTML = `
        <div style="display: flex; flex-direction: column; gap: 12px;">
          ${reports.map(report => `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; background: var(--gray-50); border-radius: var(--radius-md); border: 1px solid var(--gray-200);">
              <div style="flex: 1;">
                <div style="font-weight: 600; color: var(--gray-900); margin-bottom: 4px;">
                  ${report.vehicle_number}
                </div>
                <div style="font-size: var(--text-sm); color: var(--gray-600);">
                  ${report.inspector_name} â€¢ ${formatDate(report.inspection_date)}
                </div>
              </div>
              <div style="display: flex; gap: 8px;">
                <span class="badge ${report.defects ? 'badge-warning' : 'badge-success'}">
                  ${report.defects ? 'ATTENTION' : 'PASS'}
                </span>
                <a href="/reports-table" class="btn btn-sm btn-secondary">View</a>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
      });
    }

    function showError() {
      document.getElementById('recent-reports-list').innerHTML = `
        <div style="text-align: center; padding: 40px; color: var(--error);">
          <p>Failed to load dashboard data</p>
        </div>
      `;
    }

    // Load dashboard on page load
    document.addEventListener('DOMContentLoaded', () => {
      loadDashboard();
      lucide.createIcons();
    });
  </script>
</body>
</html>

